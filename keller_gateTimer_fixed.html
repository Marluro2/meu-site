<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Keller (PSI) ‚Äî Matem√°tica DEMO (HTML)</title>
  <style>
    :root{--bg:#0b0b0c;--card:#111114;--muted:#2a2a2e;--text:#f6f6f7;--gold:#ffca28;--gold-100:#ffe8b6}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1080px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #1f1f23;border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.35);padding:24px}
    h1,h2{margin:0;color:var(--gold)}
    .title{font-size:30px;font-weight:800}
    .muted{color:#c7c7cc}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .col{display:flex;flex-direction:column;gap:12px}
    .center{display:flex;align-items:center;justify-content:center}
    .section{display:none}
    .section.show{display:block}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:14px 22px;border-radius:14px;border:1px solid transparent;cursor:pointer;font-weight:800;color:var(--gold);background:#1f2937;transition:.15s ease}
    .btn:hover{transform:translateY(-1px);background:#243244}
    .btn-outline{background:transparent;border-color:var(--gold)}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .input{width:360px;max-width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2b2b31;background:#0f1115;color:var(--gold);font-size:18px}
    .list{display:flex;flex-direction:column;gap:10px}
    .tile{display:flex;gap:12px;align-items:flex-start;padding:12px;border:1px solid #23232a;border-radius:12px;background:#0f0f12}
    .tile .t1{font-size:22px;font-weight:700;color:var(--gold)}
    .tile .t2{font-size:16px;color:#c7c7cc}
    .radios{display:flex;flex-direction:column;gap:10px;margin:8px 0}
    .opt{display:flex;gap:10px;align-items:flex-start;background:#0e0f12;border:1px solid #24242a;border-radius:14px;padding:12px}
    .opt input{margin-top:4px;transform:scale(1.2)}
    .opt label{font-size:20px;line-height:1.35;cursor:pointer}
    .enun{font-size:26px;font-weight:700;color:var(--gold)}
    .input-ans{width:220px;max-width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2b2b31;background:#0f1115;color:var(--gold);font-size:20px}
    .prog{appearance:none;width:340px;max-width:100%;height:10px;border-radius:999px;background:#1f2937;overflow:hidden}
    .prog>span{display:block;height:100%;background:var(--gold);width:0%}
    .fb{min-height:20px;color:var(--gold-100)}
    pre{white-space:pre-wrap;word-break:break-word}
  
/* ===== Ajustes solicitados ===== */

/* Centralizar verticalmente a HOME e o MENU, com t√≠tulos maiores */
#home.show, #menu.show{
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 180px);
  text-align: center;
}
#home .title, #menu .title{
  font-size: clamp(42px, 6.5vw, 72px);
  line-height: 1.1;
  letter-spacing: .4px;
}

/* Inputs e bot√µes mais encorpados na home */
#home .input{ font-size: 20px; padding: 16px 18px; width: 460px; max-width: 92%; }
#home .btn{ font-size: 20px; padding: 16px 26px; }

/* Lista do menu mais larga e central */
#menu .list{ width: min(900px, 92vw); margin-top: 12px; }
#menu .tile{ padding: 16px 18px; }
#menu .tile .t1{ font-size: clamp(28px, 3.2vw, 42px); }
#menu .tile .t2{ font-size: clamp(18px, 2vw, 22px); }

/* Roteiro: fontes maiores e bloco de detalhes */
#roteiro #tituloU{ font-size: clamp(36px, 5vw, 56px); }
#roteiro .title{ font-size: clamp(22px, 2.4vw, 28px); }
#roteiro #objetivoU, #roteiro #roteiroU{ font-size: clamp(18px, 2vw, 22px) !important; }
#detalhesU{
  margin-top: 10px;
  padding: 12px 14px;
  border: 1px dashed #2a2a2e;
  border-radius: 14px;
  background: #0e1014;
  font-size: clamp(16px, 1.9vw, 20px);
}

/* Teste: mais destaque e centraliza√ß√£o vertical leve */
#teste.show{
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 14px;
  min-height: calc(100vh - 200px);
}
.enun{ font-size: clamp(28px, 4.5vw, 44px); }
.opt label{ font-size: clamp(20px, 2.5vw, 26px); }
.input-ans{ font-size: clamp(20px, 2.5vw, 26px); padding: 14px 16px; width: min(380px, 92vw); }
.prog{ height: 14px; }
.fb{ font-size: clamp(18px, 2vw, 22px); font-weight: 800; }
#teste .btn{ font-size: clamp(16px, 1.8vw, 20px); padding: 14px 20px; }


/* ===== Destaque RESULTADO + Elogios ===== */
#resultado.show{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-height: calc(100vh - 220px);
  text-align:center;
}
#resultado #resumo{ width:min(980px,92vw); }
#resultado #resumo pre{
  white-space:pre-wrap;
  font-size: clamp(26px, 4.2vw, 46px) !important;
  line-height:1.2;
  font-weight:900;
  margin: 6px auto 12px;
  padding: 18px 20px;
  border-radius: 18px;
  background: radial-gradient(1200px 400px at 50% -20%, rgba(255,215,64,.18), transparent),
              linear-gradient(180deg, rgba(255,215,64,.08), rgba(255,215,64,.03));
  border: 1px solid rgba(255, 215, 64, .25);
  box-shadow: 0 12px 40px rgba(255, 215, 64, .12);
  text-align:left;
}
#resultado .btn{ font-size: clamp(16px, 2vw, 22px); padding: 16px 22px; }

/* Mensagem de feedback durante o teste */
.fb .elogio{
  display:inline-block;
  margin-left: 10px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .4px;
  text-shadow: 0 2px 0 #ffe082, 0 6px 20px rgba(255,202,40,.35);
}


/* ===== Elogios + Cart√£o Resultado por status + Confete ===== */
#resultado{ position:relative; overflow:hidden; }

/* Cart√£o resultado verde (ok) x √¢mbar (fail) */
#resultado #resumo pre.ok{
  background: radial-gradient(1200px 400px at 50% -20%, rgba(76,175,80,.18), transparent),
              linear-gradient(180deg, rgba(76,175,80,.10), rgba(76,175,80,.04));
  border-color: rgba(76,175,80,.35);
  box-shadow: 0 12px 40px rgba(76,175,80,.18);
}
#resultado #resumo pre.fail{
  background: radial-gradient(1200px 400px at 50% -20%, rgba(255,193,7,.18), transparent),
              linear-gradient(180deg, rgba(255,193,7,.10), rgba(255,193,7,.04));
  border-color: rgba(255,193,7,.35);
  box-shadow: 0 12px 40px rgba(255,193,7,.18);
}

/* Elogio com MUITO destaque */
.fb .elogio{
  display:inline-block;
  margin-left: 12px;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 1000;
  text-transform: uppercase;
  letter-spacing: .5px;
  font-size: clamp(28px, 5vw, 52px);
  line-height: 1.05;
  background: linear-gradient(180deg, rgba(255,215,64,.20), rgba(255,215,64,.08));
  border: 1px solid rgba(255,215,64,.35);
  box-shadow: 0 10px 28px rgba(255,215,64,.22);
  text-shadow: 0 2px 0 #ffe082, 0 6px 22px rgba(255,202,40,.45);
}
.fb .elogio .nome{
  font-style: italic;
  text-decoration: underline dotted rgba(255,215,64,.8);
}

/* Confete simples */
.confetti{
  position:absolute;
  top:-10vh;
  width:10px; height:16px;
  opacity:.92;
  transform: translateY(-10vh) rotate(0);
  animation: confetti-fall 1.8s linear forwards;
}
@keyframes confetti-fall{
  to{
    transform: translateY(110vh) rotate(720deg);
    opacity: 0;
  }
}


/* ===== Guia de Estudo (pr√©-requisito) ===== */
#guia.card{
  margin-top: 12px;
  padding: 16px 18px;
  border-radius: 16px;
  border: 1px solid rgba(120, 144, 156, .28);
  background: linear-gradient(180deg, rgba(120,144,156,.08), rgba(120,144,156,.03));
  box-shadow: 0 10px 28px rgba(120, 144, 156, .12);
  text-align: left;
}
#guia h3{ font-size: clamp(22px, 2.6vw, 28px); margin: 0 0 8px 0; }
#guia #tempoGuia{ margin-top: 6px; font-weight: 700; }
#guia .ok{ color:#66bb6a; }
#guia .hold{ color:#ffca28; }
#ckLiGuia{ transform: scale(1.1); margin-right: 6px; }

/* ===== Modo Professor ===== */
#prof .title{ font-size: clamp(32px, 5vw, 56px); }
#logsTable{ width:min(1040px, 96vw); margin: 12px auto; overflow:auto; }
#logsTable table{ width:100%; border-collapse: collapse; }
#logsTable th, #logsTable td{
  padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,.08); text-align:left;
  font-size: clamp(14px, 1.8vw, 18px);
}
#logsTable th{ position: sticky; top:0; background: rgba(0,0,0,.25); backdrop-filter: blur(4px); }
.badge-ok{ color:#2e7d32; font-weight:900; }
.badge-no{ color:#ef6c00; font-weight:900; }

</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- HOME -->
      <section id="home" class="section show">
        <h1 class="title">PSI Keller ‚Äî DEMO (3 itens por unidade)</h1>
        <div class="col" style="margin-top:12px">
          <input id="nome" class="input" placeholder="Seu nome" />
          <button id="btn-entrar" class="btn">‚ñ∂Ô∏è Entrar</button>
        </div>
      </section>

      <!-- MENU -->
      <section id="menu" class="section">
        <h2 class="title">Unidades</h2>
        <div id="saudacao" class="muted" style="margin:8px 0"></div>
        <div id="lista" class="list"></div>
        <div class="center" style="gap:12px;margin-top:12px">
          <button id="btn-export" class="btn btn-outline">‚¨áÔ∏è Exportar CSV</button>
          <button id="btn-prof" class="btn">üë©‚Äçüè´ Modo Professor</button>
          <button id="btn-voltar-app" class="btn btn-outline">‚¨ÖÔ∏è Voltar</button>
        </div>
      </section>

      <!-- ROTEIRO -->
      <section id="roteiro" class="section">
        <div class="col">
          <div id="tituloU" class="title"></div>
          <div class="title" style="font-size:22px">Objetivo operacional</div>
          <div id="objetivoU" class="muted" style="font-size:18px"></div>
          <div class="title" style="font-size:22px">Roteiro de estudo</div>
          <div id="roteiroU" class="muted" style="font-size:18px"></div>
          <div id="detalhesU" class="muted"></div>
          <div id="guia" class="card">
            <h3>Guia de estudo</h3>
            <div id="guiaU" class="muted"></div>
            <div id="tempoGuia" class="hold">Tempo m√≠nimo de leitura: <span id="tRest">2</span>s</div>
            <label style="display:block;margin-top:8px"><input type="checkbox" id="ckLiGuia"> Li e estou pronto(a)</label>
          </div>
        
          <div class="center" style="gap:12px;margin-top:8px">
            <button id="btn-iniciar" class="btn" disabled>‚úîÔ∏è Iniciar teste (3 itens)</button>
            <button id="btn-voltar-menu1" class="btn btn-outline">üè† Voltar ao menu</button>
            <button id="btn-voltar1" class="btn btn-outline">‚¨ÖÔ∏è Voltar</button>
          </div>
        </div>
      </section>

      <!-- TESTE -->
      <section id="teste" class="section">
        <div id="enun" class="enun"></div>
        <form id="radios" class="radios" style="display:none"></form>
        <input id="entrada" class="input-ans" placeholder="Resposta" style="display:none" />
        <div id="fb" class="fb"></div>
        <div class="row">
          <div class="prog" aria-label="Progresso"><span id="bar"></span></div>
          <div id="placar" class="muted">Acertos: 0 / 0</div>
        </div>
        <div class="center" style="gap:10px;margin-top:8px">
          <button id="btn-conf" class="btn">‚úîÔ∏è Confirmar</button>
          <button id="btn-try" class="btn btn-outline" disabled>üîÅ Tentar de novo</button>
          <button id="btn-next" class="btn btn-outline" disabled>‚û°Ô∏è Pr√≥ximo</button>
          <button id="btn-voltar2" class="btn btn-outline">‚¨ÖÔ∏è Voltar</button>
        </div>
      </section>

      <!-- RESULTADO -->
      <section id="resultado" class="section">
        <div id="resumo" class="enun"></div>
        <div class="center" style="gap:12px;margin-top:12px">
          <button id="btn-restudy" class="btn btn-outline">üìò Reestudar unidade</button>
          <button id="btn-retest" class="btn">üîÅ Refazer teste</button>
          <button id="btn-voltar-menu2" class="btn btn-outline">üè† Voltar ao menu</button>
          <button id="btn-voltar3" class="btn btn-outline">‚¨ÖÔ∏è Voltar</button>
        </div>
      </section>

      <!-- MODO PROFESSOR -->
      <section id="prof" class="section">
        <h2 class="title">Modo Professor</h2>
        <div id="logsTable"></div>
        <div class="center" style="gap:12px;margin-top:12px">
          <button id="btn-export-logs" class="btn btn-outline">‚¨áÔ∏è Exportar tentativas (CSV)</button>
          <button id="btn-restore-locks" class="btn">üîí Restaurar bloqueios</button>
          <button id="btn-voltar4" class="btn btn-outline">‚¨ÖÔ∏è Voltar</button>
        </div>
      </section>


    </div>
  </div>

  <script>
    // ===== Config =====
    const NUM_ITENS_POR_TESTE = 3;

    // ===== Estado =====
    const aluno = { nome: '' };
    const progresso = new Map(); // id -> {acertos,total,done}
    const status = []; // 'open' | 'locked' | 'done'

    let currentUnit = 0;
    let itens = [];
    let idx = 0;
    let acertos = 0;
    let respondeu = false;

    // ===== Utils =====
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
    const randi = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
    const choice = (a)=> a[Math.floor(Math.random()*a.length)];
    const gcd = (a,b)=>{ a=Math.abs(a); b=Math.abs(b); while(b){ [a,b]=[b,a%b] } return a };
    const fracIrredutivel = (n,d)=>{ const g=gcd(n,d); return `${n/g}/${d/g}` };
    const parseNum = (s)=>{ if(s==null) return null; const v=String(s).trim().replace(',', '.'); const x=Number(v); return Number.isFinite(x)?x:null };

    function baixarCSV(nomeArquivo, linhas){
      const csv = linhas.map(l => l.map(v => `"${String(v).replaceAll('"','\"')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = el('a', { href:url, download:nomeArquivo });
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 3000);
    }

    // ===== Geradores de itens =====
    function itens_equacoes(qtd=6){
      const L=[]; for(let i=0;i<qtd;i++){
        const a=randi(2,6), x=randi(2,9), b=randi(1,9), c=a*x+b;
        const enun=`Resolva para x: ${a}x + ${b} = ${c}  ‚Üí  x = ?`;
        L.push({ tipo:'input', enunciado:enun, resposta_numerica:(c-b)/a, tolerancia:1e-6 });
      } return L;
    }
    function itens_distributiva(qtd=6){
      const L=[]; for(let i=0;i<qtd;i++){
        const a=randi(2,9), b=randi(1,9), c=randi(1,9);
        const enun=`Use a distributiva: ${a} x (${b} + ${c}) = ?`;
        const resp=a*b + a*c;
        const alternativas=[
          `${a*b} + ${a*c} = ${resp}`,
          `${a} + ${b} x ${c} = ${a + b*c}`,
          `${a} x ${b} + ${c} = ${a*b + c}`,
          `${a} x ${b + c} = ${a*(b+c)}`,
        ];
        for(let j=alternativas.length-1;j>0;j--){ const k=Math.floor(Math.random()*(j+1)); [alternativas[j],alternativas[k]]=[alternativas[k],alternativas[j]] }
        L.push({ tipo:'radio', enunciado:enun, alternativas, correta: alternativas.indexOf(`${a*b} + ${a*c} = ${resp}`) });
      } return L;
    }
    
function itens_fracoes(qtd=6){
      // Itens simples: fra√ß√£o de um valor em reais, com resultado inteiro
      const DENOMS = [2,3,4,5,6,8,10];
      const NUMS = [1,2,3,4,5,6,7,8,9];
      const MULTS = [10,20,30,40,50,60,80,100];
      const L=[];
      for(let i=0;i<qtd;i++){
        const d = DENOMS[Math.floor(Math.random()*DENOMS.length)];
        let n = NUMS[Math.floor(Math.random()*Math.min(d-1, NUMS.length))];
        if(n>=d) n = Math.max(1, d-1); // garante fra√ß√£o pr√≥pria
        // escolhe um valor m√∫ltiplo de d para manter resultado inteiro
        const base = MULTS[Math.floor(Math.random()*MULTS.length)];
        const valor = base * d; // m√∫ltiplo de d
        const resultado = (n/d) * valor;
        const enun = `Calcule: ${n}/${d} de ${valor} reais = ?`;
        L.push({ tipo:'input', enunciado:enun, resposta_numerica:resultado, tolerancia:1e-6 });
      }
      return L;
    }
    function itens_ordem_operacoes(qtd=6){
      const L=[]; for(let i=0;i<qtd;i++){
        const a=randi(2,9), b=randi(2,9), c=randi(2,9);
        const enun=`Resolva: ${a} + ${b} / ${c} x ${a}`;
        const valor = a + (b/c)*a;
        L.push({ tipo:'input', enunciado:enun, resposta_numerica:valor, tolerancia:1e-6 });
      } return L;
    }

    // ===== Unidades (PSI Keller DEMO) =====
    const UNIDADES = [{ id:'U1', titulo:'Equa√ß√µes 1¬∫ grau ‚Äî DEMO (3 itens)', objetivo:'Resolver ax + b = c matematicamente corretas (dom√≠nio: ‚â• 85%).', roteiro:'Ex.: 2x + 3 = 11 ‚Üí 2x = 8 ‚Üí x = 4. Isolar o termo com x e dividir pelo coeficiente.', mastery:0.85, gerador: itens_equacoes },
      { id:'U2', titulo:'Propriedade Distributiva ‚Äî DEMO (3 itens)', objetivo:'Aplicar a(b+c)=ab+ac corretamente (dom√≠nio: ‚â• 85%).', roteiro:'Ex.: 3 x (4 + 2) = 3 x 4 + 3 x 2 = 12 + 6 = 18.', mastery:0.85, gerador: itens_distributiva },
      { id:'U3', titulo:'Fra√ß√µes ‚Äî DEMO (3 itens)', objetivo:'Calcular fra√ß√µes de valores monet√°rios: (n/d) de X reais, com X m√∫ltiplo de d para resultado inteiro.', roteiro:'Passos: (1) Identifique n/d; (2) Verifique que o valor √© m√∫ltiplo de d; (3) Calcule (n/d)*valor; (4) Responda em reais.', mastery:0.85, gerador: itens_fracoes }];

    // ===== Elements =====
    const secHome = $('#home');
    const secMenu = $('#menu');
    const secRoteiro = $('#roteiro');
    const secTeste = $('#teste');
    const secResultado = $('#resultado');

    const inputNome = $('#nome');
    const btnEntrar = $('#btn-entrar');
    const lista = $('#lista');
    const saudacao = $('#saudacao');
    const btnExport = $('#btn-export');
    const btnVoltarApp = $('#btn-voltar-app');

    const tituloU = $('#tituloU');
    const objetivoU = $('#objetivoU');
    const roteiroU = $('#roteiroU');
    const btnIniciar = $('#btn-iniciar');
    const btnVoltarMenu1 = $('#btn-voltar-menu1');
    const btnVoltar1 = $('#btn-voltar1');

    // ===== PSI Keller: Logs e Guia =====
    const secProf = $('#prof');
    const logsTable = $('#logsTable');
    const btnProf = $('#btn-prof');
    const btnExportLogs = $('#btn-export-logs');
    const btnVoltar4 = $('#btn-voltar4');
    const btnRestoreLocks = $('#btn-restore-locks');

    const guiaU = $('#guiaU');
    const ckLiGuia = $('#ckLiGuia');
    const tRest = $('#tRest');
    const tempoGuia = $('#tempoGuia');

    let LOGS = [];
    try { LOGS = JSON.parse(localStorage.getItem('PSI_KELLER_LOGS')||'[]') } catch(e){ LOGS = [] }
    let attemptStart = 0;
    let attemptSeed = 0;

    function saveLogs(){ localStorage.setItem('PSI_KELLER_LOGS', JSON.stringify(LOGS)) }

    function desenharLogs(){
      if(LOGS.length === 0){
        logsTable.innerHTML = '<p class="muted">Sem tentativas registradas ainda.</p>';
        return;
      }
      const headers = ["quando","aluno","unidade","t√≠tulo","acertos","total","dom√≠nio","exigido","aprovado","tempo(s)","seed"];
      let html = '<table><thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
      for(const r of LOGS){
        html += `<tr>
          <td>${r.quando}</td>
          <td>${r.aluno}</td>
          <td>${r.unidade}</td>
          <td>${r.titulo}</td>
          <td>${r.acertos}</td>
          <td>${r.total}</td>
          <td>${Math.round(r.dominio*100)}%</td>
          <td>${Math.round(r.exigido*100)}%</td>
          <td>${r.aprovado? '<span class="badge-ok">SIM</span>':'<span class="badge-no">N√ÉO</span>'}</td>
          <td>${r.tempo_s}</td>
          <td>${r.seed}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      logsTable.innerHTML = html;
    }

    

function exportLogsCSV(){
  const headers = ["quando","aluno","unidade","t√≠tulo","acertos_tentativa","total_tentativa","dom√≠nio","exigido","aprovado","tempo(s)","seed","item_idx","item_enunciado","resposta_aluno","gabarito","correto?"];
  const linhas = [headers];
  for(const r of LOGS){
    if(Array.isArray(r.itens) && r.itens.length>0){
      for(const it of r.itens){
        linhas.push([
          r.quando, r.aluno, r.unidade, r.titulo,
          r.acertos, r.total, (r.dominio*100).toFixed(0)+'%', (r.exigido*100).toFixed(0)+'%',
          r.aprovado? 'SIM':'N√ÉO', r.tempo_s, r.seed,
          it.n, it.enunciado, it.resposta, it.gabarito, it.correto? 'SIM':'N√ÉO'
        ]);
      }
    } else {
      linhas.push([
        r.quando, r.aluno, r.unidade, r.titulo,
        r.acertos, r.total, (r.dominio*100).toFixed(0)+'%', (r.exigido*100).toFixed(0)+'%',
        r.aprovado? 'SIM':'N√ÉO', r.tempo_s, r.seed, '', '', '', '', ''
      ]);
    }
  }
  baixarCSV('keller_tentativas_itens.csv', linhas);
}

    // Bot√µes do modo professor
    if(btnProf){ btnProf.addEventListener('click', ()=>{ 
      status.length = 0; 
      status.push(...Array(UNIDADES.length).fill('open')); 
      desenharMenu(); 
      desenharLogs(); 
      go(secProf); 
    }) }
    if(btnVoltar4){ btnVoltar4.addEventListener('click', ()=> go(secMenu)) }
    if(btnExportLogs){ btnExportLogs.addEventListener('click', exportLogsCSV) }
    if(btnRestoreLocks){ btnRestoreLocks.addEventListener('click', ()=>{ 
      status.length = 0; 
      status.push('open', ...Array(UNIDADES.length-1).fill('locked')); 
      desenharMenu(); 
      go(secMenu); 
    }) }
    if(ckLiGuia){
      ckLiGuia.addEventListener('change', ()=>{
        if(ckLiGuia.checked && (!gateTimer && gateTimeLeft<=0)) btnIniciar.disabled = false;
        else btnIniciar.disabled = true;
      })
    }


    const enun = $('#enun');
    const radios = $('#radios');
    const E_EMOJIS = ['üéâ','üëè','üöÄ','üåü','üí•','üèÜ','‚ú®','‚úÖ'];
    const NEG_ELOGIOS = ['N√£o desista', 'Voc√™ √© capaz', 'Confio em voc√™', 'Tente novamente', 'Voc√™ est√° no caminho certo'];
    const ELOGIOS = ['Parab√©ns!', 'Excelente!', 'Voc√™ √© fant√°stico!', 'Fenomenal!', 'Incr√≠vel!', '√ìtimo trabalho!', 'Maravilhoso!', 'Sensacional!', 'Impec√°vel!', 'Mandou muito bem!'];
    const entrada = $('#entrada');
    const fb = $('#fb');
    const bar = $('#bar');
    const placar = $('#placar');
    const btnConf = $('#btn-conf');
    const btnTry = $('#btn-try');
    const btnNext = $('#btn-next');
    const btnVoltar2 = $('#btn-voltar2');

    const resumo = $('#resumo');
    const btnRestudy = $('#btn-restudy');
    const btnRetest = $('#btn-retest');
    const btnVoltarMenu2 = $('#btn-voltar-menu2');
    const btnVoltar3 = $('#btn-voltar3');

    // Guias por unidade (conte√∫do espec√≠fico)
    const GUIAS = {
      'U1': {
        leitura: [
          "Objetivo: resolver equa√ß√µes do 1¬∫ grau do tipo ax + b = c.",
          "Leitura b√°sica: isolar x ‚Äî subtraia/ some para remover o termo constante e divida pelo coeficiente de x.",
          "Exemplo resolvido: 3x + 6 = 21 ‚Üí 3x = 15 ‚Üí x = 5.",
          "Checklist: (1) Mantenha a igualdade; (2) Fa√ßa opera√ß√µes inversas; (3) Verifique substituindo o x encontrado."
        ]
      },
      'U2': {
        leitura: [
          "Objetivo: aplicar a propriedade distributiva: a(b + c) = ab + ac.",
          "Leitura b√°sica: distribua o fator externo a cada termo do par√™ntese.",
          "Exemplo resolvido: 3(2x + 4) = 6x + 12.",
          "Checklist: (1) Multiplique termo a termo; (2) Some termos semelhantes; (3) Verifique com um valor de x."
        ]
      },
      'U3': {
        leitura: [
          "Objetivo: calcular fra√ß√µes de valores monet√°rios do tipo (n/d) de X reais.",
          "Leitura b√°sica: escolha X como m√∫ltiplo de d; calcule (n/d) √ó X.",
          "Exemplo resolvido: 2/3 de 30 = (2√ó30)/3 = 60/3 = 20.",
          "Checklist: (1) Identifique n e d; (2) Verifique que X √© m√∫ltiplo de d; (3) Multiplique e divida; (4) Expresse o resultado em reais."
        ]
      }
    };

    function renderGuia(u){
      const g = GUIAS[u.id];
      if(!g){ guiaU.innerHTML = '<p class="muted">Guia n√£o dispon√≠vel.</p>'; return }
      const ul = '<ul style="margin:8px 0 0 18px;">' + g.leitura.map(item=>`<li>${item}</li>`).join('') + '</ul>';
      guiaU.innerHTML = ul;
    }


    // ===== Nav helpers =====
    function show(section){ section.classList.add('show') }
    function hide(section){ section.classList.remove('show') }
    function go(section){
      try {
        [secHome,secMenu,secRoteiro,secTeste,secResultado,secProf].filter(Boolean).forEach(hide);
        show(section);
      } catch(e){
        // Fallback: tenta ligar/desligar diretamente Home/Menu
        try{ secHome && secHome.classList.remove('show') }catch(_){}
        try{ secMenu && secMenu.classList.add('show') }catch(_){}
        console && console.error && console.error('Navega√ß√£o falhou:', e);
      }
    }

    // ===== UI =====
    function desenharMenu(){
      lista.innerHTML = '';
      UNIDADES.forEach((u,i)=>{
        const estado = status[i];
        const stText = estado==='locked' ? 'Bloqueada' : (estado==='done' ? 'Conclu√≠da' : 'Dispon√≠vel');
        const tile = el('div',{className:'tile'});
        const t = el('div',{className:'t1', textContent:u.titulo});
        const s = el('div',{className:'t2', textContent:`Objetivo: ${u.objetivo}  |  Status: ${stText}`});
        const pile = el('div'); pile.appendChild(t); pile.appendChild(s);
        tile.appendChild(pile);
        if(estado !== 'locked'){
          tile.style.cursor='pointer';
          tile.addEventListener('click', ()=> abrirUnidade(i));
        }
        lista.appendChild(tile);
      });
    }

    // ===== Fluxo =====
    function abrirUnidade(i){
      currentUnit = i;
      const u = UNIDADES[i];
      tituloU.textContent = u.titulo;
      objetivoU.textContent = u.objetivo;
      roteiroU.textContent = u.roteiro;
      renderGuia(u);
      resetGuiaGate();

      // Bloco extra de detalhes para orientar o aluno
      const precisa = Math.ceil(NUM_ITENS_POR_TESTE * u.mastery);
      const detalhes = [
        `Crit√©rio de dom√≠nio: ${(u.mastery*100).toFixed(0)}% (nesta DEMO: acertar pelo menos ${precisa} de ${NUM_ITENS_POR_TESTE}).`,
        "Dicas: resolva sem calculadora, use rascunho e confira o passo a passo.",
        "Erros comuns: pular etapas, distribuir errado, ignorar prioridade de √ó e √∑.",
        "Se n√£o alcan√ßar o dom√≠nio, clique em ‚ÄòReestudar unidade‚Äô e tente novamente."
      ];
      const ul = "<ul style=\"margin:8px 0 0 18px; text-align:left;\">" + detalhes.map(d=>`<li>${d}</li>`).join("") + "</ul>";
      document.getElementById('detalhesU').innerHTML = ul;

      go(secRoteiro);
    }

    function iniciarTeste(){ attemptItems = [];
      const u = UNIDADES[currentUnit];
      itens = u.gerador(NUM_ITENS_POR_TESTE);
      idx = 0; acertos = 0; respondeu = false;
      prepararItem();
      go(secTeste);
    }

    function prepararItem(){
      respondeu = false;
      entrada.value=''; fb.textContent='';
      const b = idx / NUM_ITENS_POR_TESTE; bar.style.width = (b*100)+'%';
      placar.textContent = `Acertos: ${acertos} / ${idx}`;
      const it = itens[idx];
      enun.textContent = it.enunciado;

      if(it.tipo==='radio'){
        radios.style.display=''; entrada.style.display='none';
        radios.innerHTML='';
        it.alternativas.forEach((alt,i)=>{
          const id = 'op-'+i;
          const row = el('div',{className:'opt'});
          const r = el('input',{type:'radio', name:'alt', id, value:String(i)});
          const lab = el('label',{htmlFor:id, textContent:alt});
          row.appendChild(r); row.appendChild(lab); radios.appendChild(row);
        });
      } else {
        radios.style.display='none'; entrada.style.display='';
      }

      btnConf.disabled=false; btnNext.disabled=true; btnTry.disabled=true;
    }

    

function confirmar(){
      if(respondeu) return;
      const it = itens[idx]; let ok=false;
      if(it.tipo==='radio'){
        const sel = radios.querySelector('input[name="alt"]:checked');
        if(!sel){ alert('Selecione uma alternativa.'); return }
        ok = Number(sel.value) === it.correta;
      } else {
        const val = entrada.value.trim();
        if('resposta_numerica' in it){
          const num = parseNum(val);
          if(num!=null){ const tol = it.tolerancia ?? 1e-6; ok = Math.abs(num - Number(it.resposta_numerica)) <= tol }
        } else if('resposta_texto' in it){
          ok = (val === it.resposta_texto);
        }
      }

      // Registrar item desta quest√£o
      let respAluno = '';
      let gabarito = '';
      if(it.tipo==='radio'){
        const sel2 = radios.querySelector('input[name="alt"]:checked');
        const altIndex = sel2 ? Number(sel2.value) : -1;
        const label = altIndex>=0 ? it.alternativas[altIndex] : '';
        respAluno = label;
        gabarito = it.alternativas[it.correta];
      } else {
        respAluno = entrada.value.trim();
        if('resposta_numerica' in it){ gabarito = String(it.resposta_numerica) }
        else if('resposta_texto' in it){ gabarito = String(it.resposta_texto) }
      }
      if(Array.isArray(attemptItems)) attemptItems.push({ n: idx+1, enunciado: it.enunciado, resposta: respAluno, gabarito, correto: !!ok });

      // Feedback
      const elogio = ELOGIOS[Math.floor(Math.random()*ELOGIOS.length)];
      const emo = E_EMOJIS[Math.floor(Math.random()*E_EMOJIS.length)];
      const nomeTag = aluno.nome ? `, <span class="nome">${aluno.nome}</span>` : '';
      const neg = NEG_ELOGIOS[Math.floor(Math.random()*NEG_ELOGIOS.length)];
      fb.innerHTML = ok
        ? `‚úÖ Correto! <span class="elogio">${elogio}${nomeTag} ${emo}</span>`
        : `‚úñ N√£o foi dessa vez. <span class="elogio">${neg}${nomeTag} üí™</span>`;

      if(ok) acertos += 1;
      placar.textContent = `Acertos: ${acertos} / ${idx+1}`;

      respondeu = true;
      btnConf.disabled = true;
      btnNext.disabled = false;
      btnTry.disabled = ok ? true : false;
    }


function tentarDeNovo(){
      const it = itens[idx];
      respondeu=false;
      fb.textContent='';
      btnConf.disabled=false;
      btnNext.disabled=true;
      btnTry.disabled=true;
      if(it.tipo==='radio'){
        const sel = radios.querySelector('input[name="alt"]:checked');
        if(sel) sel.checked=false;
      } else {
        entrada.value='';
      }
    }


function proximo(){
      idx += 1;
      if(idx >= NUM_ITENS_POR_TESTE){
        concluirTeste();
      } else {
        prepararItem();
        btnConf.disabled=false;
        btnNext.disabled=true;
        btnTry.disabled=true;
      }
    }

function concluirTeste(){
      const u = UNIDADES[currentUnit];
      const dominio = acertos / NUM_ITENS_POR_TESTE;
      const exige = u.mastery;
      const ok = dominio >= exige;
      resumo.innerHTML = `<pre class="${ok ? 'ok' : 'fail'}">Unidade: ${u.titulo}
Acertos: ${acertos}/${NUM_ITENS_POR_TESTE}  ‚Üí  dom√≠nio = ${(dominio*100).toFixed(0)}% (exigido: ${(exige*100).toFixed(0)}%)
${ok ? `PARAB√âNS${aluno.nome? ', '+aluno.nome.toUpperCase() : ''}! Dom√≠nio alcan√ßado. üéâ` : 'Ainda n√£o alcan√ßou o dom√≠nio. Continue praticando e tente novamente.'}</pre>`;
      progresso.set(u.id, { acertos, total: NUM_ITENS_POR_TESTE, done: ok });
      if(ok && currentUnit+1 < UNIDADES.length && status[currentUnit+1] === 'locked') status[currentUnit+1] = 'open';
      status[currentUnit] = ok ? 'done' : 'open';
      if(ok) soltarConfete();
      // Registro de tentativa
      const dur = Math.max(0, Math.round((performance.now() - attemptStart)/1000));
      LOGS.push({ quando: new Date().toISOString(), aluno: aluno.nome, unidade: u.id, titulo: u.titulo, acertos, total: NUM_ITENS_POR_TESTE, dominio, exigido: exige, aprovado: ok, tempo_s: dur, seed: attemptSeed, itens: attemptItems.slice() });
      saveLogs();
      go(secResultado);
    }

    function soltarConfete(){
      const host = document.getElementById('resultado');
      const cores = ['#ffd740','#4caf50','#29b6f6','#ff7043','#ab47bc','#66bb6a','#ffee58'];
      for(let i=0;i<80;i++){
        const s = document.createElement('span');
        s.className = 'confetti';
        const left = Math.random()*100; // vw
        const delay = Math.random()*0.4;
        const dur = 1.4 + Math.random()*0.9;
        const rot = Math.random()*360;
        s.style.left = left + 'vw';
        s.style.background = cores[i % cores.length];
        s.style.transform = `translateY(-10vh) rotate(${rot}deg)`;
        s.style.animationDuration = dur + 's';
        s.style.animationDelay = delay + 's';
        host.appendChild(s);
        setTimeout(()=> s.remove(), (delay+dur)*1000 + 300);
      }
    }

    function exportCSV(){
      const linhas = [["aluno","unidade","acertos","total","dom√≠nio?"]];
      UNIDADES.forEach(u=>{
        const reg = progresso.get(u.id) || {acertos:0,total:0,done:false};
        linhas.push([aluno.nome, u.titulo, reg.acertos, reg.total, reg.done? 'SIM':'N√ÉO']);
      });
      baixarCSV('relatorio_keller_demo.csv', linhas);
    }

    // ===== Event Bindings =====
    btnEntrar.addEventListener('click', ()=>{
      try {
        const nome = inputNome.value.trim();
      if(!nome){ alert('Digite seu nome.'); return }
      aluno.nome = nome;
      saudacao.textContent = `Bem-vindo(a), ${aluno.nome}!`;
      status.length = 0;
      status.push('open', ...Array(UNIDADES.length-1).fill('locked'));
      try { progresso.clear(); } catch(e) {}
      desenharMenu();
      go(secMenu);
      } catch(e){
        try{ secHome && secHome.classList.remove('show'); secMenu && secMenu.classList.add('show'); }catch(_){}
        alert('Iniciando com modo seguro.'); 
      }
    });

    btnExport.addEventListener('click', exportCSV);
    btnVoltarApp.addEventListener('click', ()=> go(secHome));

    btnIniciar.addEventListener('click', iniciarTeste);
    btnVoltarMenu1.addEventListener('click', ()=> { desenharMenu(); go(secMenu) });
    btnVoltar1.addEventListener('click', ()=> go(secMenu));

    btnConf.addEventListener('click', (e)=>{ e.preventDefault(); confirmar() });
    btnTry.addEventListener('click', (e)=>{ e.preventDefault(); tentarDeNovo() });
    btnNext.addEventListener('click', (e)=>{ e.preventDefault(); proximo() });
    btnVoltar2.addEventListener('click', ()=> go(secRoteiro));

    btnRestudy.addEventListener('click', ()=> go(secRoteiro));
    btnRetest.addEventListener('click', iniciarTeste);
    btnVoltarMenu2.addEventListener('click', ()=> { desenharMenu(); go(secMenu) });
    btnVoltar3.addEventListener('click', ()=> go(secMenu));
  
// --- Guia: gate de leitura (2s) ---
let gateTimeLeft = 2;
let __gateTimer = null; let gateTimer = null;
function resetGuiaGate(){
  gateTimeLeft = 2;
  if(tRest) tRest.textContent = String(gateTimeLeft);
  if(tempoGuia){ tempoGuia.classList.remove('ok'); tempoGuia.classList.add('hold'); tempoGuia.textContent = 'Tempo m√≠nimo de leitura: '; if(tRest) tempoGuia.appendChild(tRest); }
  if(ckLiGuia) ckLiGuia.checked = false;
  if(btnIniciar) btnIniciar.disabled = true;
  if(__gateTimer) clearInterval(__gateTimer); if(gateTimer) clearInterval(gateTimer);
  __gateTimer = setInterval(()=>{
    gateTimeLeft -= 1;
    if(gateTimeLeft <= 0){
      clearInterval(__gateTimer); __gateTimer = null;
      if(tempoGuia){ tempoGuia.textContent = 'Tempo m√≠nimo de leitura cumprido.'; tempoGuia.classList.remove('hold'); tempoGuia.classList.add('ok'); }
      if(ckLiGuia && ckLiGuia.checked && btnIniciar) btnIniciar.disabled = false;
    }else{
      if(tRest) tRest.textContent = String(gateTimeLeft);
    }
  }, 1000); gateTimer = __gateTimer;
}
if(ckLiGuia){
  ckLiGuia.addEventListener('change', ()=>{
    if(!__gateTimer && gateTimeLeft<=0 && ckLiGuia.checked){
      if(btnIniciar) btnIniciar.disabled = false;
    } else {
      if(btnIniciar) btnIniciar.disabled = true;
    }
  });
}

</script>
</body>
</html>
